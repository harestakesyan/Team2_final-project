---
title: "Team 2 EDA"
author: "Zhe, Chenxu, Hovhannes, Timberley, Karina"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    number_sections: false
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '3'
---

```{r init, include=FALSE}
# some of common options (and the defaults) are: 
# include=T, eval=T, echo=T, results='hide'/'asis'/'markup',..., collapse=F, warning=T, message=T, error=T, cache=T, fig.width=6, fig.height=4, fig.dim=c(6,4) #inches, fig.align='left'/'center','right', 
library(ezids)
# knitr::opts_chunk$set(warning = F, results = "markup", message = F)
knitr::opts_chunk$set(warning = F, results = "hide", message = F)
options(scientific=T, digits = 3) 
# options(scipen=9, digits = 3) 
# ‘scipen’: integer. A penalty to be applied when deciding to print numeric values in fixed or exponential notation.  Positive values bias towards fixed and negative towards scientific notation: fixed notation will be preferred unless it is more than ‘scipen’ digits wider.
# use scipen=999 to prevent scientific notation at all times
```

# Team 2 Final Project - EDA
This Cardiovascular Disease dataset is from [Kaggle](https://www.kaggle.com/datasets/sulianova/cardiovascular-disease-dataset). The variables are:  

Variable |  Definition  
  :-     |  :---- 
id	 | ID number
age	 | Age in days
gender | Gender (1: women, 2: men)
height | Height in centimeters (cm)
weight | Weight in kilograms (kg)
ap_hi | Systolic blood pressure
ap_lo | Diastolic blood pressure
cholesterol | Cholesterol (1: normal, 2: above normal, 3: well above normal)
gluc | Glucose (1: normal, 2: above normal, 3: well above normal)
smoke | Whether patient smokes or not (0: no, 1: yes)
alco | Whether patient consumes alcohol or not (0: no, 1: yes)
active | Whether patient is physically active or not (0: no, 1: yes)
cardio | Presence or absence of cardiovascular disease (0: absent, 1: present)

```{r, results='markup'}
cardio_orig = data.frame(read.csv("cardio_train.csv", header = TRUE, sep=';'))
str(cardio_orig)
```  
There are `r nrow(cardio_orig)` observations in the dataset.  
 
We remove the `id` column and converted `age` from days to years.  We added a new column `bmi`, for body mass index. Body mass index (BMI) is a measure of body fat based on height and weight, and the formula is $BMI = kg/m^2$. The new data frame is saved as `cardio`.  
```{r, results='markup'}

cardio = cardio_orig[-c(1)]
cardio$age = cardio$age/365 # transfer days to years
cardio$bmi = cardio$weight/(cardio$height/100)**2

#xkablesummary(cardio, title = "Cardio Data Frame Summary" )
head(cardio)
```  

We see that there are unexpected minimum and maximum observations for `height`, `weight`, `ap_hi`, `ap_lo` and `bmi`.  Blood pressure measurements as low as -150 and maximum as high as 16020 are incompatable with life, as are BMIs of 3.5 and 299.  We use the `outlierKD2()` function to remove the outliers.  

Removing `height`, `weight`, `ap_hi`, `ap_lo` we get:

```{r}
#cardio_clean = outlierKD2(cardio, height, TRUE, TRUE, TRUE, TRUE) 
#cardio_clean = outlierKD2(cardio_clean, weight, TRUE, TRUE, TRUE, TRUE)
#cardio_clean = outlierKD2(cardio_clean, ap_hi, TRUE, TRUE, TRUE, TRUE) 
#cardio_clean = outlierKD2(cardio_clean, ap_lo, TRUE, TRUE, TRUE, TRUE)
```  

Alternatively, we can remove `bmi`, `ap_hi` and `ap_lo` to get:
```{r}
cardio_clean = outlierKD2(cardio, bmi, TRUE, TRUE, TRUE, TRUE) 
cardio_clean = outlierKD2(cardio_clean, ap_hi, TRUE, TRUE, TRUE, TRUE) 
cardio_clean = outlierKD2(cardio_clean, ap_lo, TRUE, TRUE, TRUE, TRUE)
``` 

After the outliers were dropped, the QQ-plots improved, indicating the distribution is closer to normal. The "stair-case" pattern on the blood pressure QQ-plots is due to discrete or rounded values. We can also see the more normal distribution in the histograms and box plots for all of the variables.  

```{r, results='markup'}
xkablesummary(cardio_clean, title = "Clean Cardio Data Frame Summary" )
cardio_clean = na.omit(cardio_clean) #remove NA rows

#change variables to factor
cardio_clean_final <- transform(cardio_clean, gender=as.factor(gender),
                      alco = as.factor(alco),
                      smoke = as.factor(smoke), 
                      active = as.factor(active), 
                      cholesterol=as.factor(cholesterol), 
                      gluc= as.factor(gluc), 
                      cardio=as.factor(cardio))

str(cardio_clean_final)
```  

We remove the NA rows with the `na.omit()` function and save over the `cardio_clean` data frame. We changed the following variables to categorical (factors): `gender`, `cholesterol`, `gluc`, `smoke`, `alco`, `active` and `cardio` and saved the data frame as `cardio_clean_final`. There are now `r nrow(cardio_clean_final)` observations in the clean data frame.

### Has disease vs healthy
#### What do cardiovascular disease patients look like?
```{r}
disease <- subset(cardio_clean_final, cardio==1)
healthy <- subset(cardio_clean_final, cardio==0)
#summary(disease)

xkablesummary(subset(disease, select=c(age, gender, ap_hi, ap_lo, cholesterol, bmi)), title="Heart Disease Patient Attributes")
```
Here we have picked out a few factors from the summary that have significant differences between factor levels. `r xkablesummary(subset(disease, select=c(age, gender, weight, ap_hi, ap_lo, cholesterol, bmi)), title="Heart Disease Patient Attributes")` In this data set, we see that all except a few heart disease patients are `above the age of 40`.  It would  make sense that most heart disease patients are older patients. Approximately two/thirds of heart disease patients are `women`. Most heart disease patients have `higher blood pressure` and `high cholesterol` levels. The average heard disease patient is also overweight, with a `bmi` > 25.0.

## Categorical Variables

```{r, results='markup'}
library(ggpubr)

gender_1 <- ggplot(cardio_clean_final, aes(x=gender, fill=cardio)) +
                   geom_bar(position="fill") +
                   scale_fill_manual(values=c("pink3", "steelblue")) +
                   scale_x_discrete(labels=c("1" = "Women", "2" = "Men")) +
                   labs(title="gender", x="", y="Proportion") +
                   theme(legend.position="top")

cholesterol_1 <- ggplot(cardio_clean_final, aes(x=cholesterol, fill= cardio)) +
                   geom_bar(position="fill") +
                   scale_fill_manual(values=c("pink3", "steelblue")) +
                   scale_x_discrete(labels=c("1" = "normal", "2" = "above normal","3" = "well above normal")) +
                   labs(title="cholesterol", x="", y="Proportion") +
                   theme(legend.position="top")
gluc_1<- ggplot(cardio_clean_final, aes(x=gluc, fill= cardio)) +
                   geom_bar(position="fill") +
                   scale_fill_manual(values=c("pink3", "steelblue")) +
                   scale_x_discrete(labels=c("1" = "normal", "2" = "above normal","3" = "well above normal")) +
                   labs(title="gluc", x="", y="Proportion") +
                   theme(legend.position="top")

smoke_1<- ggplot(cardio_clean_final, aes(x=smoke, fill= cardio)) +
                   geom_bar(position="fill") +
                   scale_fill_manual(values=c("pink3", "steelblue")) +
                   scale_x_discrete(labels=c("0" = "No smoking", "1" = "Smoking")) +
                   labs(title="smoke", x="", y="Proportion") +
                   theme(legend.position="top")

alco_1<- ggplot(cardio_clean_final, aes(x=alco, fill= cardio)) +
                   geom_bar(position="fill") +
                   scale_fill_manual(values=c("pink3", "steelblue")) +
                   scale_x_discrete(labels=c("0" = "No alcohol intake", "1" = "Alcohol intake")) +
                   labs(title="alco", x="", y="Proportion") +
                   theme(legend.position="top")

active_1<- ggplot(cardio_clean_final, aes(x=active, fill= cardio)) +
                   geom_bar(position="fill") +
                   scale_fill_manual(values=c("pink3", "steelblue")) +
                   scale_x_discrete(labels=c("0" = "No physical activity", "1" = "Physical activity" )) +
                   labs(title="active", x="", y="Proportion") +
                   theme(legend.position="top")

ggarrange(gender_1, cholesterol_1,gluc_1, smoke_1, alco_1,active_1)

```  

**1. According to the plot above, we can draw the conclusion that**
*It's close to half the female and male population have cardiovascular disease.
*The higher the degree of cholesterol and glucose ， more population have this disease.
*It is surprised that whether patient smokes or not and consumes alcohol or not, Almost half of them have this disease.
* Do physical exercise can slightly help us decrease the probability of cardiovascular disease.

**2. According to the plot above, we can draw the conclusion that:**
- Half of all men and all women have cardiovasulcar disease
- Higher cholesterol and higher glucose levels can be linked to higher incidence of cardiovascular disease.
- Almost half of smokers and drinkers have cardiovascular disease.
- Doing physical exercise helps decrease the probability of getting cardiovascular disease.

**Chi-square tests**
We can use a $\chi^2$ test to determine if the categorical variables and presence of cardiovascular disease are independent.

<<<<<<< HEAD
<<<<<<< HEAD
=======
<<<<<<< Updated upstream
  
=======
>>>>>>> main
# Team 2 Final Project - Categorical variables EDA - Zhe  

**Look at the structure of the dataframe `cardio_clean_final`.**
```{r}
str(cardio_clean_final)
```  



**Chi-square test was used to test whether the categorical variables and presence of cardiovascular disease are independent.**  

=======

### Gender
>>>>>>> main
**1. Whether `cardio` and `gender` are independent.**  
- H0: cardio and gender are independent.  
- H1: they are not independent.  

```{r, results='markup'}
cardio_vs_gender = table(cardio_clean_final$cardio, cardio_clean_final$gender)
#rownames(cardio_vs_gender) = c("Absent","Present")
#colnames(cardio_vs_gender) = c("Female", "Male")
#xkabledply(cardio_vs_gender, title="Contingency table for Gender vs Cardiovascular Disease Status")

chi_gender = chisq.test(cardio_vs_gender)
chi_gender
```  
* In this data set, there gender and cardiovascular disease are NOT significantly independent. 
* The p-value from the Chi-square test is 0.2, which is larger than 0.05. So we failed to reject the null hypothesis. This result indicating `gender` difference won't affect the onset of  cardiovascular diseases. 
* Since p-value = `r format(chi_gender$p.value, scientific=T)` > 0.05, we fail to reject the null hypothesis, so `gender` does not have a significant impact on contracting cardiovascular disease.

### Cholesterol
**2. Whether `cardio` and `cholesterol` are independent.**  
- H0: cardio and cholesterol are independent.  
- H1: they are not independent.  
```{r results='markup'}
cardio_vs_cholesterol = table(cardio_clean_final$cardio, cardio_clean_final$cholesterol)
chi_cholesterol = chisq.test(cardio_vs_cholesterol)
chi_cholesterol
```  
* The p-value from the Chi-square test is less than 2e-16, which is smaller than 0.05. So we can reject the null hypothesis. This result indicating `cholesterol` level will contribute to the onset of cardiovascular diseases.  
* Since p-value = `r format(chi_cholesterol$p.value, scientific=T)` < 0.05, we reject the null hypothesis, so `cholesterol` does have a significant impact on contracting cardiovascular disease.

### Glucose
**3. Whether `cardio` and `gluc` are independent.**  
- H0: cardio and gluc are independent.  
- H1: they are not independent.  
```{r results='markup'}
cardio_vs_glucose = table(cardio_clean_final$cardio, cardio_clean_final$gluc)
chi_glucose = chisq.test(cardio_vs_glucose)
chi_glucose
```  
* The p-value from the Chi-square test is less than 2e-16, which is smaller than 0.05. So we can reject the null hypothesis. This result indicating glucose (`gluc`) level will contribute to the onset of cardiovascular diseases. 
* Since p-value = `r format(chi_glucose$p.value, scientific=T)` < 0.05, we reject the null hypothesis, so `glucose` does have a significant impact on contracting cardiovascular disease.

### Smoking
**4. Whether `cardio` and `smoke` are independent.**  
- H0: cardio and smoke are independent.  
- H1: they are not independent.  
```{r results='markup'}
cardio_vs_smoke = table(cardio_clean_final$cardio, cardio_clean_final$smoke)
chi_smoke = chisq.test(cardio_vs_smoke)
chi_smoke
```  
*The p-value from the Chi-square test is 3e-08, which is smaller than 0.05. So we can reject the null hypothesis. This result indicating smoke or not will contribute to the onset of cardiovascular diseases.  
*Since p-value = `r format(chi_smoke$p.value, scientific=T)` < 0.05, we reject the null hypothesis, so `smoking` does have a significant impact on contracting cardiovascular disease.

### Alcohol
**5. Whether `cardio` and `alco` are independent.**  
- H0: cardio and alco are independent.  
- H1: they are not independent.  
```{r results='markup'}
cardio_vs_alco = table(cardio_clean_final$cardio, cardio_clean_final$alco)
chi_alco = chisq.test(cardio_vs_alco)
chi_alco
```  
* The p-value from the Chi-square test is 0.002, which is smaller than 0.05. So we can reject the null hypothesis. This result indicating whether the patient consumes alcohol or not will contribute to the onset of cardiovascular diseases. 
* Since p-value = `r format(chi_alco$p.value, scientific=T)` < 0.05, we reject the null hypothesis, so `alcohol` does have a significant impact on contracting cardiovascular disease.

### Physical Activity
**6. Whether `cardio` and `active` are independent.**  
- H0: cardio and active are independent.  
- H1: they are not independent.  
```{r results='markup'}
cardio_vs_active = table(cardio_clean_final$cardio, cardio_clean_final$active)
chi_active = chisq.test(cardio_vs_active)
chi_active
```  
* The p-value from the Chi-square test is less then 2e-16, which is smaller than 0.05. So we can reject the null hypothesis. This result indicating whether the patient is physically active or not will contribute to the onset of cardiovascular diseases.  
* Since p-value = `r format(chi_active$p.value, scientific=T)` < 0.05, we reject the null hypothesis, so `activity` does have a significant impact on contracting cardiovascular disease.

<<<<<<< HEAD
**Based on the Chi-square tests we performed, we found `gender` is not contribute to the presence or absence of cardiovascular disease, while `cholesterol`, `gluc`, `smoke`, `alco` and `active` are the variables that can affect whether the patient has cardiovascular disease or not.
=======
**Based on the Chi-square tests we performed, we found `gender` is not contribute to the presence or absence of cardiovascular disease, while `cholesterol`, `gluc`, `smoke`, `alco` and `active` are the variables that can affect whether the patient has cardiovascular disease or not.**
>>>>>>> main

<<<<<<< HEAD




<<<<<<< HEAD
=======
>>>>>>> Stashed changes
>>>>>>> main
=======
## Continuous Variables
A brief overview of the dataset tells us we have the following continuous variables: `age`, `height`, `weight`, `systolic blood pressure`, `diastolic blood pressure`, plus the new `bmi` variable we added.

##4.1 KDE plot of continuous variables
The following plots are stacked for better visualization of the distribution.
```{r,results='markup'}
age_kdeplot <- ggplot(cardio_clean_final, aes(x = age, fill= cardio)) + 
  geom_density(position = "stack") +
  geom_vline(aes(xintercept=mean(age)), color="black", linetype="dashed", size=1) +
  xlab("Age ") + ylab("Proportion") + 
  ggtitle(expression(atop("Age Distribution (stacked)")))+
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_fill_manual(values=c("pink3", "steelblue"),labels=c("Absent", "Present")) + 
  xlim(30, 70)
age_kdeplot
```  
The percentage of disease shows that the age of patients with disease mainly concentrate on around 55.


```{r,results='markup'}
height_kdeplot<-  ggplot(cardio_clean_final, aes(x = height, fill= cardio)) + 
  geom_density(position = "stack") +
  geom_vline(aes(xintercept=mean(height)), color="black", linetype="dashed", size=1) +
  xlab("Height(in cm) ") + ylab("Proportion") + 
  ggtitle(expression(atop("Height Distribution (stacked)")))+
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_fill_manual(values=c("pink3", "steelblue"),labels=c("Absent", "Present")) + 
  xlim(125, 200)

height_kdeplot
```
The height density is about the same for cardio absent and present patients.
  
```{r,results='markup'}
weight_kdeplot<- ggplot(cardio_clean_final, aes(x = weight, fill= cardio)) + 
  geom_density(position = "stack") +
  geom_vline(aes(xintercept=mean(weight)), color="black", linetype="dashed", size=1) +
  xlab("Weight(in kg) ") + ylab("Proportion") + 
  ggtitle(expression(atop("Weight Distribution (stacked)")))+
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_fill_manual(values=c("pink3", "steelblue"),labels=c("Absent", "Present")) + 
  xlim(0, 150)

weight_kdeplot
```
The mean weight of patients with cardiovascular disease is slightly higher than those without cardiovascular disease.

```{r,results='markup'}
bmi_kdeplot<- ggplot(cardio_clean_final, aes(x = bmi, fill= cardio)) + 
  geom_density(position = "stack") +
  geom_vline(aes(xintercept=mean(bmi)), color="black", linetype="dashed", size=1) +
  xlab("BMI") + ylab("Proportion") + 
  ggtitle(expression(atop("BMI Distribution (stacked)")))+
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_fill_manual(values=c("pink3", "steelblue"),labels=c("Absent", "Present")) + 
  xlim(0, 50)

bmi_kdeplot
```
We see a much higher proportion of patients with cardiovascular disease at BMIs of >25 (overweight is >25, obese is >30).

```{r,results='markup'}
ap_hi_kdeplot<- ggplot(cardio_clean_final, aes(x = ap_hi, fill= cardio)) + 
  geom_density(position = "stack") +
  geom_vline(aes(xintercept=mean(ap_hi)), color="black", linetype="dashed", size=1) +
  xlab("Systolic blood pressure(ap_hi) ") + ylab("Proportion") + 
  ggtitle(expression(atop("Systolic blood pressure Distribution (stacked)")))+
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_fill_manual(values=c("pink3", "steelblue"),labels=c("Absent", "Present")) + 
  xlim(85, 175)

ap_hi_kdeplot
```  
The proportion of patients with cardiovascular disease increases as systolic blood pressure increases.

```{r,results='markup'}

ap_lo_kdeplot<-ggplot(cardio_clean_final, aes(x = ap_lo, fill= cardio)) + 
  geom_density(position = "stack") +
  geom_vline(aes(xintercept=mean(ap_lo)), color="black", linetype="dashed", size=1) +
  xlab("Diastolic blood pressure(ap_lo)) ") + ylab("Proportion") + 
  ggtitle(expression(atop("Diastolic blood pressure Distribution (stacked)")))+
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_fill_manual(values=c("pink3", "steelblue"),labels=c("Absent", "Present")) + 
  xlim(60, 110)

ap_lo_kdeplot

```
The proportion of patients with cardiovascular disease increases as diastolic blood pressure increases.  

As we can see from age_kdeplot, `older` patients are more likely to have `cardiovascular disease`. From the `height` and `weight` KDE plots, indicate there is no major correlation between `height` or `weight` and `cardiovascular disease`. Patients with high BMI (>25) are more likely to have cardiovascular disease. For the last two KDE plots (`blood pressure`), patients with `higher blood pressure appear to be more likely to have `cardiovascular disease`.

**T-tests**
We can use a two-sample t-test to compare if the continuous variable means with and without cardiovascular disease are different. 

### Age
**1. Whether age mean is different between `cardiovascular disease` positive and negative patients**  
- H0: cardio_pos and cardio_neg average ages are independent.  
- H1: they are not independent.  
```{r, results='markup'}
cardio_pos = subset(cardio_clean_final, cardio_clean_final$cardio == 1)
cardio_neg = subset(cardio_clean_final, cardio_clean_final$cardio == 0)

ttest_age = t.test(cardio_pos$age, cardio_neg$age)
ttest_age
```  
* Since p-value = `r format(ttest_age$p.value)` < 0.05, we reject the null hypothesis and accept the alternative that the mean `age` of patients with cardiovascular disease is different from patients without cardiovascular disease.
* The p-value is very low

### Height
**2. Whether height mean is different between `cardiovascular disease` positive and negative patients**  
- H0: cardio_pos and cardio_neg average heights are independent.  
- H1: they are not independent.  

```{r, results='markup'}
ttest_height = t.test(cardio_pos$height, cardio_neg$height)
ttest_height
```  
* Since p-value = `r format(ttest_height$p.value)` < 0.05, we reject the null hypothesis and accept the alternative that the mean `height` of patients with cardiovascular disease is different from patients without cardiovascular disease.  However, both of the estimated means are 165cm, and the true difference interval at $a=0.05$ is only -0.364, -0.120.

### Weight
**3. Whether weight mean is different between `cardiovascular disease` positive and negative patients**  
- H0: cardio_pos and cardio_neg average weights are independent.  
- H1: they are not independent. 

```{r, results='markup'}
ttest_weight = t.test(cardio_pos$weight, cardio_neg$weight)
ttest_weight
```  
* Since p-value = `r format(ttest_weight$p.value)` < 0.05, we reject the null hypothesis and accept the alternative that the mean `weight` of patients with cardiovascular disease is different from patients without cardiovascular disease.  
* The p-value is very low  

### BMI
**6. Whether BMI mean is different between `cardiovascular disease` positive and negative patients**  
- H0: cardio_pos and cardio_neg average BMI are independent.  
- H1: they are not independent. 
```{r, results='markup'}
ttest_bmi = t.test(cardio_pos$bmi, cardio_neg$bmi)
ttest_bmi
```  
* Since p-value = `r format(ttest_bmi$p.value)` < 0.05, we reject the null hypothesis and accept the alternative that the mean `bmi` of patients with cardiovascular disease is different from patients without cardiovascular disease.  
* The p-value is very low  

### Systolic Blood Pressure
**4. Whether systolic blood pressure is different between `cardiovascular disease` positive and negative patients**  
- H0: cardio_pos and cardio_neg average systolic blood pressure are independent.  
- H1: they are not independent. 

```{r, results='markup'}
ttest_ap_hi = t.test(cardio_pos$ap_hi, cardio_neg$ap_hi)
ttest_ap_hi
```
* Since p-value = `r format(ttest_ap_hi$p.value)` < 0.05, we reject the null hypothesis and accept the alternative that the mean `ap_hi` of patients with cardiovascular disease is different from patients without cardiovascular disease.  
* The p-value is very low  

### Diastolic Blood Pressure
**5. Whether diastolic blood pressure is different between `cardiovascular disease` positive and negative patients**  
- H0: cardio_pos and cardio_neg average diastolic blood pressure are independent.  
- H1: they are not independent. 

```{r, results='markup'}
ttest_ap_lo = t.test(cardio_pos$ap_lo, cardio_neg$ap_lo)
ttest_ap_lo
```  
* Since p-value = `r format(ttest_ap_lo$p.value)` < 0.05, we reject the null hypothesis and accept the alternative that the mean `ap_lo` of patients with cardiovascular disease is different from patients without cardiovascular disease.  
* The p-value is very low  

## Correlations

```{r, results='markup'}
loadPkg("corrplot")

col_order <- c("age", "gender", "height", "weight", "ap_hi", "ap_lo", "cholesterol", "gluc", "smoke", "alco", "active", "bmi", "cardio")
cardio_clean_cor <- cardio_clean[, col_order]

# corrplot with spearman method for categorical variables
cardio_cor <- cor(cardio_clean_cor, method="spearman")
corrplot(cardio_cor, type="lower", addCoef.col="black", number.cex=0.5, tl.cex=0.7,title="Correlation Matrix", mar=c(0,0,1,0))
```  
We see that cardiovascular disease has the strongest correlation with blood pressure (`ap_hi` & `ap_lo`), `cholesterol`, `age`, and `BMI.`

### Is there a relationship between blood pressure and other variables in patients with cardiovascular disease?
```{r, results='markup'}
#library(patchwork)
#install.packages("ggExtra")
library(ggExtra)

ap1 <- ggplot(cardio_clean_final,aes(x = cholesterol , y = ap_hi, fill = cardio)) + 
  geom_violin() + 
  labs(title = "Systolic Blood Pressure vs Cholesterol") +
  xlab("Cholesterol") + ylab("Systolic BP") + 
  scale_fill_manual(values=c("pink3", "steelblue"),labels=c("Absent", "Present")) +
  scale_x_discrete(labels=c("1" = "normal", "2" = "above normal","3" = "well above normal")) + 
  geom_hline(yintercept = 120, linetype = 'dashed')
ap1

ap2 <- ggplot(cardio_clean_final, aes(x=age, y=ap_hi, color=cardio)) +
  geom_point(size = 1.5, alpha=0.7) + 
  labs(title = "Systolic Blood Pressure vs Age") + 
  xlab("Age ") + ylab("Systolic BP") +
  scale_color_manual(values=c("pink3", "steelblue"), labels = c("Absent", "Present")) +
  geom_hline(yintercept = 120, linetype = 'dashed')
#ap2
ggMarginal(ap2, type = "density", groupFill = TRUE)

ap3 <- ggplot(cardio_clean_final, aes(x=bmi, y=ap_hi, color=cardio)) +
  geom_point(size=1.5,alpha=0.7) + 
  labs(title = "Systolic Blood Pressure vs BMI") + 
  xlab("BMI ") + ylab("Systolic BP") +
  scale_color_manual(values=c("pink3", "steelblue"), labels = c("Absent", "Present")) + 
  geom_hline(yintercept = 120, linetype = 'dashed')
#ap3
ggMarginal(ap3, type = "density", groupFill = TRUE)
```  
Normal blood pressure for most adults is defined as a systolic pressure of less than 120 and a diastolic pressure of less than 80 (NIH)[https://www.nia.nih.gov/health/high-blood-pressure-and-older-adults]. Because there is a strong correlation between systolic and diastolic blood pressure, we look at systolic in comparison to other variables: `cholesterol`, `age` and `bmi.`  

*Systolic BP vs Cholesterol*
* In the normal and above normal cholesterol groups, patients with cardiovascular disease tend to have systolic blood pressure at or above 120, whereas patients without cardiovascular disease have higher density at healthy systolic levels.
* In the well above normal cholesterol group, the systolic blood pressure distribution was similar in patients with and without cardiovascular disease.

*Systolic BP vs Age*
* There does not appear to be linear relationship between systolic blood pressure and age, however we can see that younger patients with normal blood pressure are less likely to have cardiovascular disease than older patients with elevated blood pressure.

*Systolic BP vs BMI*
* There does not appear to be a linear relationship between systolic blood pressure and BMI, however patients with lower BMI and blood pressure are less likely to have cardiovascular disease than patients with higher BMI and elevated blood pressure.

### Is there a relationship between cholesterol and other variables in patients with cardiovascular disease?
```{r, results='markup'}

chol1 <- ggplot(cardio_clean_final,aes(x = cholesterol , y = age, fill = cardio)) + 
  geom_violin() + 
  labs(title = "Age vs Cholesterol") +
  xlab("Cholesterol") + ylab("Age") + 
  scale_fill_manual(values=c("pink3", "steelblue"),labels=c("Absent", "Present")) +
  scale_x_discrete(labels=c("1" = "normal", "2" = "above normal","3" = "well above normal"))
chol1

chol2 <- ggplot(cardio_clean_final,aes(x = cholesterol , y = bmi, fill = cardio)) + 
  geom_violin() + 
  labs(title = "BMI vs Cholesterol") +
  xlab("Cholesterol") + ylab("BMI") + 
  scale_fill_manual(values=c("pink3", "steelblue"),labels=c("Absent", "Present")) +
  scale_x_discrete(labels=c("1" = "normal", "2" = "above normal","3" = "well above normal"))
chol2

```
### Is there a relationship between age and other variables in patients with cardiovascular disease?
```{r, results='markup'}
age1 <- ggplot(cardio_clean_final, aes(x=age, y=bmi, color=cardio)) +
  geom_point(size=1,alpha=0.7) + 
  labs(title = "BMI vs Age") + 
  xlab("Age") + ylab("BMI") +
  scale_color_manual(values=c("pink3", "steelblue"), labels = c("Absent", "Present"))
ggMarginal(age1, type = "density", groupFill = TRUE)
```

### How do lifestyle choices influence cardiovascular disease with other variables?
*Smoking*
```{r, results='markup'}

smoke1 <- ggplot(cardio_clean_final,aes(x = smoke , y = ap_hi, fill = cardio)) + 
  geom_violin() + 
  labs(title = "Systolic Blood Pressure vs Smoke") +
  xlab("Smoke") + ylab("Systolic BP") + 
  scale_fill_manual(values=c("pink3", "steelblue"),labels=c("Absent", "Present")) +
  scale_x_discrete(labels=c("0" = "no", "1" = "yes")) + 
  geom_hline(yintercept = 120, linetype = 'dashed')
smoke1

smoke2 <- ggplot(cardio_clean_final,aes(x = smoke , y = age, fill = cardio)) + 
  geom_violin() + 
  labs(title = "Age vs Smoke") +
  xlab("Smoke") + ylab("Age") + 
  scale_fill_manual(values=c("pink3", "steelblue"),labels=c("Absent", "Present")) +
  scale_x_discrete(labels=c("0" = "no", "1" = "yes"))
smoke2

smoke3 <- ggplot(cardio_clean_final,aes(x = smoke , y = bmi, fill = cardio)) + 
  geom_violin() + 
  labs(title = "BMI vs Smoke") +
  xlab("Smoke") + ylab("BMI") + 
  scale_fill_manual(values=c("pink3", "steelblue"),labels=c("Absent", "Present")) +
  scale_x_discrete(labels=c("0" = "no", "1" = "yes"))
smoke3

```
*Alcohol*

```{r, results='markup'}

alco1 <- ggplot(cardio_clean_final,aes(x = smoke , y = ap_hi, fill = cardio)) + 
  geom_violin() + 
  labs(title = "Systolic Blood Pressure vs Alcohol") +
  xlab("Alcohol") + ylab("Systolic BP") + 
  scale_fill_manual(values=c("pink3", "steelblue"),labels=c("Absent", "Present")) +
  scale_x_discrete(labels=c("0" = "no", "1" = "yes")) +
  geom_hline(yintercept = 120, linetype = 'dashed')

alco1

alco2 <- ggplot(cardio_clean_final,aes(x = smoke , y = age, fill = cardio)) + 
  geom_violin() + 
  labs(title = "Age vs Alcohol") +
  xlab("Alcohol") + ylab("Age") + 
  scale_fill_manual(values=c("pink3", "steelblue"),labels=c("Absent", "Present")) +
  scale_x_discrete(labels=c("0" = "no", "1" = "yes"))
alco2

alco3 <- ggplot(cardio_clean_final,aes(x = smoke , y = bmi, fill = cardio)) + 
  geom_violin() + 
  labs(title = "BMI vs Alcohol") +
  xlab("Alcohol") + ylab("BMI") + 
  scale_fill_manual(values=c("pink3", "steelblue"),labels=c("Absent", "Present")) +
  scale_x_discrete(labels=c("0" = "no", "1" = "yes"))
alco3

```

*Physical Activity*
```{r, results='markup'}

active1 <- ggplot(cardio_clean_final,aes(x = active , y = ap_hi, fill = cardio)) + 
  geom_violin() + 
  labs(title = "Systolic Blood Pressure vs Activity") +
  xlab("Activity") + ylab("Systolic BP") + 
  scale_fill_manual(values=c("pink3", "steelblue"),labels=c("Absent", "Present")) +
  scale_x_discrete(labels=c("0" = "no", "1" = "yes"))+
  geom_hline(yintercept = 120, linetype = 'dashed')

active1

active2 <- ggplot(cardio_clean_final,aes(x = active , y = age, fill = cardio)) + 
  geom_violin() + 
  labs(title = "Age vs Activity") +
  xlab("Activity") + ylab("Age") + 
  scale_fill_manual(values=c("pink3", "steelblue"),labels=c("Absent", "Present")) +
  scale_x_discrete(labels=c("0" = "no", "1" = "yes"))
active2

active3 <- ggplot(cardio_clean_final,aes(x = active , y = bmi, fill = cardio)) + 
  geom_violin() + 
  labs(title = "BMI vs Activity") +
  xlab("Activity") + ylab("BMI") + 
  scale_fill_manual(values=c("pink3", "steelblue"),labels=c("Absent", "Present")) +
  scale_x_discrete(labels=c("0" = "no", "1" = "yes"))
active3

```

*Blood Glucose*
```{r, results='markup'}

gluc1 <- ggplot(cardio_clean_final,aes(x = gluc , y = ap_hi, fill = cardio)) + 
  geom_violin() + 
  labs(title = "Systolic Blood Pressure vs Blood Glucose") +
  xlab("Blood Glucose") + ylab("Systolic BP") + 
  scale_fill_manual(values=c("pink3", "steelblue"),labels=c("Absent", "Present")) +
  scale_x_discrete(labels=c("1" = "normal", "2" = "above normal","3" = "well above normal"))+
  geom_hline(yintercept = 120, linetype = 'dashed')

gluc1

gluc2 <- ggplot(cardio_clean_final,aes(x = gluc , y = age, fill = cardio)) + 
  geom_violin() + 
  labs(title = "Age vs Blood Glucose") +
  xlab("Blood Glucose") + ylab("Age") + 
  scale_fill_manual(values=c("pink3", "steelblue"),labels=c("Absent", "Present")) +
  scale_x_discrete(labels=c("1" = "normal", "2" = "above normal","3" = "well above normal"))
gluc2

gluc3 <- ggplot(cardio_clean_final,aes(x = gluc , y = bmi, fill = cardio)) + 
  geom_violin() + 
  labs(title = "BMI vs Blood Glucose") +
  xlab("Blood Glucose") + ylab("BMI") + 
  scale_fill_manual(values=c("pink3", "steelblue"),labels=c("Absent", "Present")) +
  scale_x_discrete(labels=c("1" = "normal", "2" = "above normal","3" = "well above normal"))
gluc3

```  
#  Feature selection  
In the EDA, t-tests and Chi-square tests were used to compare whether the response variables `age`, `gender`, `height`, `weight`, `ap_hi`, `ap_lo`, `cholesterol`, `gluc`, `smoke`, `alco`, `active` and `bmi` have effects on the predictor variable `cardio`, and the p-values of the tests were shown in the table below:  
```{r results='markup'}
tab <- matrix(c( '<2e-16','0.6', '8e-07', '<2e-16', '<2e-16', '<2e-16', '<2e-16', '<2e-16', '1e-06', '0.006', '<2e-16', '<2e-16'), ncol=12, byrow = TRUE)
rownames(tab) <- "p_value"
colnames(tab) <- c("Age_year", "Gender", "Height","Weight","Systolic(ap_hi)", "Diastolic(ap_low)", "Cholesterol","Glucose","smoke", "Alcohol", "Physical_activity","BMI")
tab <- as.table(tab)
xkabledply(tab, "p-value Comparison")  
```

**From the above table, we found that all the response variables have relationship with the predictor variable `cardio` except the `gender` variable. Next we further confirmed this and tested the strength of the relationships with the `bestglm` function.  

```{r bestglm, results='markup'}
loadPkg("bestglm")
loadPkg("leaps")
loadPkg("ggplot2")
cardio_clean_final_glm <- cardio_clean_final
colnames(cardio_clean_final_glm)[12] <- "y"
cardio_clean_final_glm <- cardio_clean_final_glm[c("age", "gender", "height", "weight","ap_hi", "ap_lo", "cholesterol", "gluc", "smoke", "alco", "active", "bmi", "y")]

res.bestglm <- bestglm(Xy = cardio_clean_final_glm, family = binomial,
            IC = "AIC", method = "exhaustive")
summary(res.bestglm)
res.bestglm$BestModels
summary(res.bestglm$BestModels)
unloadPkg("bestglm") 
unloadPkg("leaps") 
```
`gender` and `bmi` were excluded from the model that has lowest criterion value, indicating these two valuables may not have strong effects on `cardio`. But among the 5 models the function generated, `gender` was voted as `FALSE` three time, while `bmi` was only voted twice, so we are not confidence in removing these two valuables from the following modeling steps. In the KNN modeling, we compare whether these two variables can affect the model performances.   

#  **K-Nearest Neighbor (KNN)**   
##  **Convert factors into numeric, and Scale/center the data**   
```{r results='markup'}
cardio_num <- cardio_clean_final_glm
colnames(cardio_num)[13] <- "cardioi"
cardio_num[1:12] <- sapply(cardio_num[1:12],as.numeric)
cardio_scale <- cardio_num
cardio_scale[1:12] <- as.data.frame(scale(cardio_num[1:12], center = TRUE, scale = TRUE))
str(cardio_scale)
```  
Dataframe structure after pre-modeling treatment was shown in the above table. All the response variables were converted in to nueric, and were scaled and centered. They are ready for KNN modeling.  
## **KNN modeling using variables with all 13 variables.**  
## Train / Test split:  

The dataframe was split into training subset (70% of the total dataframe) and test subset (30% of the total dataframe).  
```{r}
set.seed(42)
cardio_sample <- sample(2, nrow(cardio_scale), replace=TRUE, prob=c(0.7, 0.3))
cardio_training_x <- cardio_scale[cardio_sample==1, 1:12]
cardio_test_x <- cardio_scale[cardio_sample==2, 1:12]
cardio_training_y <- cardio_scale[cardio_sample==1, 13]
cardio_test_y <- cardio_scale[cardio_sample==2, 13]
```

## Looking for the best K value:  
Odd numbers from 3 to 40 were test one by one to get the best K value. The accuracy values from the model that used these K values were shown in the table and the line graph. According the results, K = 19 is the best K value if we use all the 13 variables for modeling.  

```{r}
loadPkg("FNN")
loadPkg("gmodels")
loadPkg("caret")
K_test <- seq(3, 40, by = 2)
ResultDf = data.frame()
for (k_v in K_test) {
  cardio_pred <- knn(train = cardio_training_x, test = cardio_test_x, cl=cardio_training_y, k=k_v)
  cardio_PRED_Cross <- CrossTable(cardio_test_y, cardio_pred, prop.chisq = FALSE)
  
  cm = confusionMatrix(cardio_pred, reference = cardio_test_y )
  
  cmaccu = cm$overall['Accuracy']

  cmt = data.frame(k=k_v, Total.Accuracy = cmaccu, row.names = NULL ) 
  
  ResultDf = rbind(ResultDf, cmt)
}
```
```{r results='markup'}
xkabledply(ResultDf, "Total Accuracy Summary")
```

```{r}
library(ggplot2)
ggplot(ResultDf, aes(x=k, y=Total.Accuracy)) +
  geom_line(color = "skyblue", size = 1.5) +
  geom_point(size = 3, color = "blue") + 
  labs(title = "Total.Accuracy vs K")
```  

Detailed results and the confusion matrix using K=19 were shown below. The following information can be calculated from the confusion matrix:  
* Accuracy = 0.717  
* Precision = 0.732  
* Recall = 0.676  
* Specification = 0.757  
* F1 Score = 0.703  
The overall performance is acceptable, but we still want to see whether remove `gender` and `bmi` can improve the modeling.  

```{r results='markup'}
  cardio_pred_19 <- knn(train = cardio_training_x, test = cardio_test_x, cl=cardio_training_y, k=19)
  cardio_PRED_Cross <- CrossTable(cardio_test_y, cardio_pred_19, prop.chisq = FALSE)
  cm = confusionMatrix(cardio_pred_19, reference = cardio_test_y)
  cmaccu = cm$overall['Accuracy']
  print( paste("Accuracy_K_19 = ", cmaccu ) )
```
## **KNN modeling using variables without `gender` and `bmi`.**  
## Train / Test split:  
The dataframe was split into training subset (70% of the total dataframe) and test subset (30% of the total dataframe). The valuables `gender` and `bmi` were excluded from the train/test split.
```{r}
cardio_scale2 <- cardio_scale[c(1, 3:11, 13)]
cardio_scale2
set.seed(42)
cardio_sample2 <- sample(2, nrow(cardio_scale2), replace=TRUE, prob=c(0.7, 0.3))
cardio_training_x2 <- cardio_scale2[cardio_sample2==1, 1:10]
cardio_test_x2 <- cardio_scale2[cardio_sample2==2, 1:10]
cardio_training_y2 <- cardio_scale2[cardio_sample2==1, 11]
cardio_test_y2 <- cardio_scale2[cardio_sample2==2, 11]
```

## Looking for the best K value:  
Odd numbers from 3 to 40 were used for the test. The accuracy values from the model that used these K values were shown in the table and the line graph. According the results, K = 29 is the best K value for the KNN modeling without `gender` and `bmi`.

```{r}
K_test <- seq(3, 40, by = 2)
ResultDf2 = data.frame()
for (k_v in K_test) {
  cardio_pred2 <- knn(train = cardio_training_x2, test = cardio_test_x2, cl=cardio_training_y2, k=k_v)
  cardio_PRED_Cross2 <- CrossTable(cardio_test_y2, cardio_pred2, prop.chisq = FALSE)
  
  cm2 = confusionMatrix(cardio_pred2, reference = cardio_test_y2 )
  
  cmaccu2 = cm2$overall['Accuracy']

  cmt2 = data.frame(k=k_v, Total.Accuracy = cmaccu2, row.names = NULL ) 
  
  ResultDf2 = rbind(ResultDf2, cmt2)
}
```
```{r results='markup'}
xkabledply(ResultDf2, "Total Accuracy Summary")
```

```{r}
library(ggplot2)
ggplot(ResultDf2, aes(x=k, y=Total.Accuracy)) +
  geom_line(color = "skyblue", size = 1.5) +
  geom_point(size = 3, color = "blue") + 
  labs(title = "Total.Accuracy vs K")
```  


Detailed results and the confusion matrix using K=29 were shown below. The following information can be calculated from the confusion matrix:  
* Accuracy = 0.722  
* Precision = 0.740  
* Recall = 0.676  
* Specification = 0.766  
* F1 Score = 0.753  


* Accuracy = 0.717  
* Precision = 0.732  
* 

```{r results='markup'}
  cardio_pred_29 <- knn(train = cardio_training_x2, test = cardio_test_x2, cl=cardio_training_y2, k=29)
  cardio_PRED_Cross <- CrossTable(cardio_test_y2, cardio_pred_29, prop.chisq = FALSE)
  cm2 = confusionMatrix(cardio_pred_29, reference = cardio_test_y2 )
  cmaccu2 = cm2$overall['Accuracy']
  print( paste("Accuracy_K_29 = ", cmaccu2 ) )
```
                
**After remove `gender` and `bmi`, the Accuracy increased from 0.717 to 0.722, Precision increased from 0.732 to 0.74, the Specification increased from 0.757 ti 0.766, and the F1 Score increased from 0.703 to 0.753, while the Recall value remained unchanged. These results suggesting remove these two variables can slightly improve the modeling performance, especially improved its ability in predicting the absence of the cardiovascular diseases.**

